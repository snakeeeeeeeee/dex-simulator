# 本地DEX模拟器需求文档

## 场景描述

用于链上套利，通过本地模拟计算避免频繁RPC交互，实现高效的执行模拟和利润评估。模拟器支持沙盒模式（临时fork池子状态进行计算，不影响主状态），便于快速测试多条套利路径。

## 总体需求

1. 实现一个本地DEX模拟器，用于套利的本地利润计算。采用模块化设计，每个链/DEX独立模块，便于扩展；优先处理EVM兼容链（如BSC、Ethereum），后续支持Solana的账户模型。
2. 支持EVM上流行DEX（PancakeSwap、Uniswap、SushiSwap），Solana上流行DEX（Raydium、Orca、Jupiter）。MVP聚焦BSC链PancakeSwap，扩展时定义统一接口规范（如Rust
   trait或Go interface），确保跨链/DEX模块无缝切换。
3. 从BSC链开始，DEX聚焦PancakeSwap，支持V2（恒定乘积模型k = x \* y）、V3（集中流动性）、V4（动态费用、钩子机制），优先级依次为V2
   &gt; V3 &gt; V4。共性逻辑（如储备更新、事件处理）抽取到抽象层，避免重复代码。
4. 先构建最小MVP核心。范围控制在PancakeSwap V2标准pair（无stable/no-fee池子），V3/V4逐步扩展，输出JSON格式模拟结果（包含利润、滑点）。
5. 文档整合DeFi开发经验，涵盖精度管理（BigInt/u128避免溢出）、安全过滤（防honeypot池子）、成本考虑（RPC节点费用）。

## MVP核心的具体要求

1. 实时监听链上事件（Swap、Mint、Burn）以同步池子状态，动态发现新池子。

    - 监听池子创建事件（PairCreated，从PancakeSwap
      V2工厂0xcA143Ce32Fe78f1f7019d7d551a6402fC5350c73，V3工厂0x0BFbCF9fa4f9C56B0F40a671Ad40E0805A091865，V4工厂待定）。
    - 使用WebSocket订阅事件（推荐wss://bsc-dataseed.binance.org），过滤topic（Swap、Mint、Burn、PairCreated）减少数据量。
    - 事件处理原子性：按块号排序事件队列，处理时锁定池子状态（mutex或类似机制），避免并发更新乱序。
    - 处理网络分叉：订阅newHeads事件，检测链重组并回滚本地状态到上一确认块。
    - 共性抽取：事件监听逻辑抽象为通用模块（如EventListener trait），支持V2/V3/V4不同事件签名。

2. 本地模拟高效实现DEX核心功能，确保影响池子状态的操作（swap、添加/移除流动性）准确重放，保持本地与链上池子一致。

    - 核心功能：
        - V2：getReserves、sync储备、swap计算（基于x\*y=k，手续费0.25%）。
        - V3：tick-based流动性、sqrtPriceX96计算、动态fee（0.05%/0.3%/1%）。
        - V4：动态费用（基于钩子Hook）、自定义池子逻辑（需解析V4 Hook合约）。
    - 高效存储：池子状态使用内存HashMap（key: pair地址，value: 储备/tick），持久化使用sled或rocksdb（防重启丢失）。
    - 精度管理：所有计算使用高精度类型（Rust u128或ethers.js BigNumber），处理dust amounts和rounding误差。
    - 过滤无效池子：忽略储备低于阈值（推荐1 BNB）的池子，防止honeypot攻击。
    - 共性抽取：抽象PoolState（储备、价格、流动性）、SwapCalculator（输入/输出计算）接口，V2/V3/V4实现具体逻辑。

3. 提供模拟交易功能，快速计算单笔或多笔swap结果，考虑swap顺序影响（每笔更新储备，影响后续价格）。

    - 支持多跳路径（e.g., A-&gt;WBNB-&gt;B），使用图算法（BFS）自动发现路径，基于配置token子集。
    - 沙盒模拟：fork池子状态计算，失败时回滚；输出包括inputAmount、outputAmount、slippage、gas估算（可选）。
    - 参数化输入：支持amountIn、minAmountOut、path、feeTier（V3/V4动态费用）。
    - V4特殊性：模拟钩子逻辑（如动态fee调整、限价订单），需解析V4合约代码。
    - 共性抽取：抽象PathFinder（路径搜索）、SwapSimulator（模拟执行）模块，V2/V3/V4复用路径逻辑。

4. 启动/重启时与链上DEX同步池子状态，定期（定块）验证一致性。
    - 初始同步：扫描历史PairCreated事件（V2/V3/V4工厂），从最近检查点（推荐最近100块）开始，避免全链扫描。
    - 定期验证：每5-10块（约15-30秒）采样10%池子，比较本地储备（V2: getReserves，V3/V4:
      slot0/sqrtPriceX96）；偏差&gt;0.1%时触发重同步并记录警告。
    - 重同步机制：仅针对不一致池子局部重放事件。
    - 共性抽取：抽象StateSyncer模块，统一同步/验证逻辑，适配V2/V3/V4储备结构。

5. 实现BSC上的PancakeSwap（V2、V3、V4）。

    - 使用官方ABI（V2: GitHub pancakeswap/pancake-smart-contracts，V3: pancakeswap/pancake-v3-core，V4: 待官方发布）。
    - 硬编码地址：V2工厂（0xcA143Ce32Fe78f1f7019d7d551a6402fC5350c73），V3工厂（0x0BFbCF9fa4f9C56B0F40a671Ad40E0805A091865），V4工厂待定。
    - MVP聚焦V2标准pair（无stable/no-fee），V3/V4逐步扩展。
    - 共性抽取：抽象ContractCaller（调用合约方法，如getReserves/slot0），复用RPC交互逻辑。

6. 支持配置token列表，未配置时输出警告，根据配置查找相关池子。

    - 配置格式：JSON文件（示例：`{"tokens": ["BNB", "USDT", "BUSD"]}`）。
    - 无配置时：警告“未配置token，性能风险高，限制top 100流动性池子”，按储备TVL排序。
    - 自动扩展：包括wrapped token（WBNB），构建token图（Graph）过滤无关池子。
    - 共性抽取：抽象TokenGraph模块，统一V2/V3/V4池子筛选逻辑。

7. 高性能计算支持任意语言。

    - 推荐Rust：高性能、并行处理、安全、无GC；使用web3-rs或ethers-rs库。
    - 备选Go：goroutines适合并发监听；避免JS单线程瓶颈。
    - 混合使用：Rust实现核心模拟模块，JS/TS提供CLI或Web接口。
    - 性能目标：1000池子、多笔swap计算&lt;1ms，使用rayon（Rust并行库）优化路径计算。
    - 共性抽取：抽象ComputeEngine接口，封装高性能计算逻辑，V2/V3/V4复用。


8. 测试与调试

    - 单元测试：mock Swap/Mint/Burn/PairCreated事件，验证V2/V3/V4 swap计算精度（与PancakeSwap SDK对比）。
    - 集成测试：fork BSC testnet，模拟实时事件同步和套利计算。
    - 日志系统：记录事件、不一致状态、性能指标（推荐Rust slog/log4rs）。
    - 调试接口：CLI命令（如`dump_pool_state`、`simulate_path`）输出池子状态/模拟结果。

9. 风险与安全

    - RPC限速：使用付费节点（Alchemy/Infura，预算约10$/月），配置多节点fallback。
    - 数据一致性：处理RPC延迟/错误，使用指数退避重试（exponential backoff）。
    - 安全：模拟器仅读RPC，不连接钱包；文档声明“仅用于计算，不执行交易”。
    - 防honeypot：过滤低流动性池子（储备&lt;1 BNB）或异常行为池子。

10. 输出与接口

    - API设计：REST/CLI接口（示例：`/simulate_swap?path=BNB->USDT&amount=1`），输出JSON（profit、slippage、path）。
    - 文档：生成README，包含架构图、配置示例、扩展指南、FAQ。

11. 扩展规划

    - Solana支持：独立模块，使用solana-sdk；同步基于JSON-RPC logs。
    - 其他DEX：插件式支持（Uniswap V3需tick模拟，SushiSwap需额外fee逻辑）。
    - 套利优化：集成路径搜索（Dijkstra/Bellman-Ford），支持利润阈值过滤和多路径比较。

## 需求合理性评估与改进建议

1. 整体路线正确，但需阶段化交付：建议明确每个阶段的产出（如首阶段仅实现 PancakeSwap V2 事件同步 + Swap 模拟 + CLI），避免 V3/V4 需求分散资源。
2. 事件监听复杂度高：拆出独立的事件日志队列模块，事件入库（如 RocksDB）后再顺序处理，可支持断线恢复与重放。
3. 初始同步应先支持离线快照导入：设计池子状态快照格式（携带版本号、校验信息），新节点可快速落地，降低首次全链扫描压力。
4. 性能目标需量化基准：补充硬件参考配置与可接受的延迟区间（例如千池批量模拟控制在 1-5ms 内），并预留 Profiling 与 Benchmark 工具链。
5. 模块抽象需配套接口示例：为 EventListener、PoolState、SwapCalculator 等关键 trait/interface 提供伪代码或接口定义，确保团队实现一致。
6. Solana 规划需补充关键差异：说明 account model、tick array、compute budget 限制及迁移路径，便于后续模块化扩展。
7. 安全与配置中心：建议搭建统一配置（YAML/JSON）与热更新机制，集中管理 RPC 列表、过滤阈值、滑点/风控指标，并在日志中记录异常事件。
8. 监控与告警：补充需采集的指标（事件处理耗时、同步延迟、池子偏差率）及日志方案（如 slog + Prometheus exporter），确保运行可观测性。
9. 测试体系完善：为单测、集成、性能测试指定工具链（Rust `cargo test`、本地 forknet 模拟、性能压测脚本），并规划基础 CI 管线。
10. 网络依赖与成本：估算公共/付费 RPC 调用量与费用，明确何时切换自建节点或多节点 fallback 策略。

## 补充说明

1. 参考资源：PancakeSwap SDK（docs.pancakeswap.finance）、Uniswap V2/V3白皮书、Flashbots MEV-Geth。
2. 开发建议：优先实现V2事件监听和池子同步（确保一致性），再扩展V3/V4；预留Solana接口。

潜在挑战：BSC分叉频繁，需监控newHeads；V4钩子逻辑复杂，需动态解析；免费RPC限速，预算付费节点。
