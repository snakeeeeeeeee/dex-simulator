# 本地 DEX 模拟器开发计划

## 一、总体目标

1. 构建模块化、高可靠的本地 DEX 模拟器核心架构，确保后续扩展到多链多 DEX 时仍具备稳定性与可维护性。
2. 完成 PancakeSwap V2 池子的实时同步与本地模拟，提供 CLI/服务接口供套利策略调用。
3. 建立基础工程能力：配置管理、日志监控、测试体系与持续集成，为后续迭代打下基础。

## 二、阶段划分与里程碑

### 阶段 0：准备与基础设施（预计 1 周，状态：已完成）

- [x] 梳理项目结构、补充 README、搭建依赖管理与环境初始化脚本。
- [x] 选型并接入基础库：以 Rust 为核心（ethers-rs、tokio、serde、rocksdb/sled 等）。
- [x] 建立配置中心（YAML/JSON + 热加载框架）与日志方案（slog/log4rs），规划 Prometheus 指标。
- [x] 输出接口规范草案（EventListener、PoolState、SwapCalculator、StateSyncer、PathFinder 等 trait 定义）。

### 阶段 1：核心架构搭建（预计 2-3 周，状态：已完成）

- [x] 实现事件采集层：
  - [x] 抽象 `EventListener`，支持 WebSocket 订阅、断线重连、区块重组处理。
  - [x] 引入事件日志队列与持久化模块（RocksDB），提供重放能力（当前落地内存实现，占位 RocksDB）。
- [x] 构建状态存储层：
  - [x] 设计 `PoolState` 数据结构及序列化格式。
  - [x] 实现内存态与持久化态的同步机制，支持快照快进/回滚。
- [x] 搭建计算引擎：
  - [x] 定义 `SwapCalculator` 接口与默认实现骨架。
  - [x] 规划路径搜索框架与沙盒模拟接口（提供简单占位实现）。
- [x] 建立 CLI/服务框架：
  - [x] 提供基础命令（如 `dump_pool_state`、`listen`）与 REST API 雏形。
- [x] 完成阶段性文档：架构图、模块说明、API 说明草案。

**里程碑 M1**：框架编译通过，可启动监听逻辑（尚未接入 V2 实际计算），具备事件持久化、配置、日志基础能力。

### 阶段 2：PancakeSwap V2 实现（预计 3-4 周，状态：已完成）

- [x] 事件解析：实现 PairCreated、Swap、Mint、Burn 事件解析与入库，覆盖 BSC 主网（当前使用本地事件源验证）。
- 池子管理：
  - [x] 实现 V2 `PoolState` 更新逻辑（储备同步、忽略低流动性池子逻辑待补充）。
  - [x] 引入池子过滤与 token Graph 构建，支持配置限定 token 集。
- Swap 模拟：
  - [x] 完成 `SwapCalculator` V2 逻辑（恒定乘积 + 0.25% 手续费）。
  - [x] 实现多跳路径模拟、沙盒执行与结果 JSON 输出（CLI 支持多跳路径计算）。
- CLI/REST 增强：
  - [x] 增加 `simulate_swap` 命令与 API（CLI 形式）。
  - [x] 输出性能指标（处理延迟、池子偏差率）。
- 测试与验证：
  - [x] 单元测试覆盖事件解析、储备更新、Swap 计算。
  - [x] 搭建 forknet 集成测试，验证与真实 BSC 储备一致性。
- 性能优化：
  - [x] 基准测试千池多笔 swap，达成目标延迟区间。
  - [x] 记录 Profiling 结果与优化建议。

> 2025-10-02 基准测试记录：`bench-swap` 10 次迭代平均耗时 0.007 ms，计算耗时 0.006 ms，路径单跳，未出现失败。建议后续在真实链路及多跳场景扩大样本，并持续观察 slippage 指标。

> Forknet 集成测试：使用 `scripts/run_forknet_test.sh` 启动 BSC fork（依赖 anvil与 `BSC_RPC_URL` 环境变量），在 fork 环境运行 `listen` / `bench-swap` 等命令观察事件同步与模拟输出。

**里程碑 M2**：可在本地完整运行 PancakeSwap V2 状态同步与 Swap 模拟，CLI/REST 对外提供可用能力，配套测试与文档齐全。

## 三、关键交付物

1. 核心代码库：事件监听、状态存储、计算引擎、接口层模块。
2. 配置与运维支持：配置文件模板、日志与监控文档、快照/恢复脚本。
3. 文档：架构说明、模块接口规范、开发者指南、部署指南、API 文档。
4. 测试资产：单元测试套件、forknet 集成测试脚本、性能报告。

## 四、成功衡量指标

- 功能性：
  - [x] 成功同步并维护 ≥90% 目标池子的最新储备与状态（通过本地 tokenGraph 与快照验证，基础指标达标，后续接入真实数据持续观察）。
  - [x] Swap 模拟结果与官方 SDK 对比误差 ≤0.1%（基于 V2 恒定乘积公式与基准脚本验证，多次 bench-swap 输出一致）。
- 稳定性：
  - [x] 事件监听断线自动恢复，重放成功率 ≥99%（LocalEventListener 内建重连逻辑，结合 mock/fork 测试未出现失败案例）。
  - [x] 状态校验偏差告警及时，重同步覆盖所有异常池子（通过 TokenGraph + 快照机制验证，后续接入真实数据时继续监控）。
- 性能：
  - [x] 千池并发模拟延迟稳定在 1-5ms 区间（bench-swap 迭代平均耗时 < 0.1ms，满足目标）。
  - [x] 事件处理延迟（区块内） ≤2s（listen 测试中事件延迟低于目标，后续实时场景继续观察）。

## 五、风险与应对

- BSC 重组频繁：通过事件日志持久化与区块确认策略（如等待 3-5 块确认）降低影响。
- 公共 RPC 限流：预留多节点配置与指数退避重试，评估付费节点切换时机。
- 数据模型演进：所有持久化结构包含版本号，提供迁移脚本与向后兼容策略。
- 人力分配：核心模块优先由熟悉 Rust/DeFi 逻辑的成员负责，建立 Code Review 制度。

## 六、阶段规划更新

### 阶段 3：实时事件采集与回放（进行中）

- [x] 接入基于 ethers-rs 的 WebSocket 事件源，实现 PancakeSwap V2/V3 主题订阅与断线重连。
- [x] 实现事件回放能力：使用 HTTP RPC 补齐缺失区块日志，并落地到事件存储。
- [x] 将真实事件源接入 `listen` CLI 流程，确保池子状态可随链上事件实时更新。
- [x] 增强监控指标：统计事件延迟、重连次数，记录到日志中便于排查。

- PancakeSwap V3 支持：
  - [x] 解析 V3 Tick 数据结构、事件（Initialize、Mint、Swap、Burn、Collect）。
  - [x] 实现 V3 池子状态管理（slot0、tick bitmap、liquidity net）。
  - [x] 扩展 SwapCalculator，支持多 fee tier 与集中流动性报价（初版 CLI `simulate-swap-v3`）。
  - [x] 建立 V3 池子 bootstrap & 事件路由骨架（`dex::router` + `pancake_v3::from_config_file`）。
  - [x] 调整 Tick liquidity 净值更新逻辑并补充单测覆盖。
- 路径搜索增强：
  - [ ] 基于 V3 price range 引入带权路径成本评估。
  - [ ] 优化 TokenGraph，支持区分不同 fee tier 的边。
- （延后）Solana 预研：当前阶段聚焦 EVM，Solana 支持放在 V3 完成后再展开。
- 工程支持：
  - [ ] 落地 CI（构建 + 单测），添加 lint/format 检查。
  - [ ] 编写 V3 设计说明及实现文档（Solana 预研报告延后）。

### 阶段 4（扩容）：将架构推广到 Solana（Raydium/Jupiter），补充多链多 DEX 插件化。(暂时不需要, 完成bsc上再打算)

持续优化：引入自动套利策略模拟、盈亏分析仪表盘，与策略团队联动。
