# 项目运行与使用指南

本指南介绍 Dex Simulator 在本地环境的准备、配置以及常用命令，帮助快速验证 PancakeSwap V2/V3 状态同步与 Swap 模拟能力。

## 1. 环境准备

1. 安装 Rust 工具链（推荐使用 rustup）。
2. 执行脚本 `./scripts/setup_env.sh`，确保切换到稳定版工具链并检查 cargo 是否可用。
3. （可选）如需通过代理访问外部网络，请先准备好代理命令。例如运行 CLI 前在新 shell 执行 `proxy`。

## 2. 配置说明

项目默认读取 `config/default.yaml`，主要字段如下：

- `network`
  - `chain_id`：目标链 ID（默认 56，对应 BSC）。
  - `ws_endpoint` / `http_endpoint`：WebSocket 与 HTTP RPC 地址，可替换为自建或付费节点。
  - `event_backfill_blocks`：启动时回放的历史区块数量，建议在公共节点上适度调低避免限流。
  - `ws_retry_secs`：WS 初始重连间隔（秒），内部带指数退避。
  - `backfill_chunk_size`：回放请求单批区块跨度。
- `runtime.snapshot_path`：快照持久化目录。
- `tokens.whitelist`：监控 Token 地址白名单（可选）。
- `dex.pancake_v2_bootstrap` / `dex.pancake_v3_bootstrap`：预加载需要追踪的 V2/V3 池子列表（用于链上快照初始化与事件路由）。
- `monitoring`
  - `event_delay_warn_ms`：事件延迟告警阈值（毫秒）。
  - `event_stats_interval`：每处理多少事件输出一次统计日志。

如需不同环境，可复制 `config/default.yaml` 并修改后通过 `--config <path>` 指定。

## 3. 编译与基本验证

```bash
cargo check            # 快速验证依赖与构建
cargo build --release  # 编译 CLI 可执行文件
```

> 提示：编译生成的二进制位于 `target/release/dex-simulator-cli`。

## 4. CLI 常用命令

启动命令时默认加载配置文件，可通过 `--config` 覆盖。重构后 CLI 入口与命令保持不变，仍然通过 `cargo run --release -- --config <path> ...` 调用。

### 4.1 实时监听

```bash
cargo run --release -- --config config/default.yaml listen --sample-events 0
```

- `--sample-events 0`：使用真实 WebSocket 事件源。程序将回放最新 `event_backfill_blocks` 个区块，并持续订阅实时日志。
- 若需快速验证流程，可设置 `--sample-events <N>` 触发内置 Mock 事件源。
- 监听过程中可通过日志观察：
  - WebSocket 连接/重连与指数退避。
  - 回放请求的区块区间与限流告警。
  - 实时事件计数、延迟告警。
- 使用 `Ctrl+C` 结束；结束后最新池子快照会存储在 `runtime.snapshot_path`。

### 4.2 Swap 模拟

单池 V2 模拟示例：

```bash
cargo run --release -- --config config/default.yaml simulate-swap --pool sample --amount 1000000000000000000
```

- 当 `pool` 为 `sample` 时，程序会加载示例快照；也可提供格式为 `chain_id:dex:pool_address:pool_type` 的具体池子标识。

V3 Demo：

```bash
cargo run --release -- --config config/default.yaml simulate-swap-v3 --amount 1000000000000000
```

### 4.3 性能基准

```bash
cargo run --release -- --config config/default.yaml bench-swap --pool sample --amount 1000000000000000000 --iterations 50
```

输出会包含每次迭代的耗时统计、路径信息与最终快照。

## 5. 快照数据

- 默认快照目录：`data/snapshots`（或配置指定的路径）。
- 快照文件名格式：`<chainId>_<dex>_<poolAddress>_<poolType>.yaml`。
- 可使用 `dump-pool-state` 命令查看快照内容：

```bash
cargo run --release -- dump-pool-state --pool <pool_identifier>
```

## 6. 常见问题

1. **WebSocket 频繁断线**：公共节点可能限流，建议缩小 `event_backfill_blocks`、`backfill_chunk_size`，或更换稳定节点。
2. **限流/timeout**：日志中出现 `limit exceeded` 或 `Operation timed out`，可改用付费节点或降低回放频率。
3. **代理命令缺失**：若执行 `proxy` 报错，可改用 `zsh -lc 'proxy && ...'` 或确认代理脚本的位置。

---

如需更多背景与开发计划，请参考 `docs/开发计划.md`。EOF
